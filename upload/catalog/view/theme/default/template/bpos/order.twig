
 <div class="order-page">
      <!-- Topbar -->
      <div class="topbar-order">
        <div class="wrap">
          <div class="brand"><div class="logo"></div><h1>Order Management</h1></div>
          <div class="chips" id="summaryChips">
            <!-- summary injected -->
          </div>
          <div class="spacer"></div>
          <div class="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
            <input id="searchBox" type="text" placeholder="Search order ID / customer ( / )" />
          </div>
          <button class="btn" id="btnNew">+ New Order</button>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters">
        <div class="wrap">
          <div class="f">
            <label>Store</label>
            <select id="fStore" title="Select one or more stores">
              <!-- options injected -->
            </select>
          </div>
          <div class="f">
            <label>Date</label>
            <select id="fDate">
              <option value="today">Today</option>
              <option value="yesterday">Yesterday</option>
              <option value="thisweek" selected>This Week</option>
              <option value="thismonth">This Month</option>
              <option value="custom">Custom‚Ä¶</option>
            </select>
            <input id="fFrom" type="date" class="hide">
            <span class="tiny hide" id="tilde">‚Äì</span>
            <input id="fTo" type="date" class="hide">
          </div>
          <div class="f">
            <label>Status</label>
            <select id="fStatus">
                <option value="">All</option>
                {% for status in order_statuses %}
                  <option value="{{ status.order_status_id }}">{{ status.name }}</option>
                {% endfor %}
              </select>
          </div>
          <div class="f">
            <label>Payment</label>
            <select id="fPayment">
              <option value="">All</option>
              <option>QRIS</option>
              <option>Cash</option>
              <option>Transfer</option>
              <option>COD</option>
            </select>
          </div>
          <div class="f">
            <label>Channel</label>
            <select id="fChannel">
              <option value="">All</option>
              <option>POS</option>
              <option>Online</option>
              <option>Marketplace</option>
            </select>
          </div>
          <div class="f">
            <label>Cashier</label>
            <select id="fCashier">
              <option value="">All</option>
              <option>Rina</option>
              <option>Adi</option>
              <option>Budi</option>
            </select>
          </div>
<!--          <div class="pillbar" id="activePills"></div>-->
        </div>
      </div>

      <div class="content">
        <!-- Analytics top-metric -->
        <div class="top-metric card">
          <h4>Today Overview</h4>

            <span class="top-corner">Auto‚Äërefresh <input id="autoRefresh" type="checkbox" checked="" aria-label="auto refresh every 30s"></span>

          <div class="top-metric-inner">
            <!-- Analytics top-metric -->
            <div class="metric"><div class="muted tiny">Orders</div><b id="mOrders">3</b></div>
            <div class="metric"><div class="muted tiny">Revenue</div><b id="mRevenue">Rp&nbsp;4.773.407</b></div>
            <div class="metric"><div class="muted tiny">Store Revenue</div>
              <div id="mTopStores" class="tiny"><div>Shopee: <b>Rp&nbsp;4.773.407</b></div></div>
            </div>
            <div class="metric">
              <div class="muted tiny">Sales Trend (7d)</div>
              <svg class="spark" id="spark" viewBox="0 0 100 30" preserveAspectRatio="none"><polyline points="0,28 16.666666666666664,28 33.33333333333333,28 50,2 66.66666666666666,4.090790678521262 83.33333333333334,28 100,28" fill="none" stroke="#1e3a8a" stroke-width="2"></polyline><circle r="2" cx="100" cy="28" fill="#1e3a8a"></circle></svg>
            </div>
            <div class="grid">

               <button class="btn ghost right" id="btnExport" title="Export filtered orders to CSV">Export EXCEL</button>
              <button class="btn neutral right" id="btnRefresh">Refresh</button>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="card table">
          <table id="orderTable" aria-label="Orders table (use ‚Üë‚Üì to navigate)">
            <thead>
              <tr>
                <th style="width:44px"><input type="checkbox" id="checkAll" /></th>
                <th>Order</th>
                <th>Customer</th>
                <th>Store</th>
                <th>Date</th>
                <th>Status</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Channel</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

    </div>

<div class="drawer" id="drawer" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <header>
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <h3 id="drawerTitle">Order #‚Äî</h3>
          <span id="orderStatusBadge" class="badge info">‚Äî</span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn tiny ghost" id="btnPrintInvoice" data-order="0">üßæ Print Invoice</button>
          <button class="btn tiny ghost" id="btnPrintReceipt" data-order="0">üßæ Print Receipt</button>
         {#  <button class="btn tiny ghost" id="btnSendEmail">üì§ Send Email</button>
          <button class="btn tiny ghost" id="btnLabel">üè∑Ô∏è Shipping Label</button> #}
          {# <button class="btn tiny ghost bad" id="btnCancel">‚ùå Cancel</button> #}
          <button class="btn tiny ghost" data-close>Close</button>
        </div>
      </header>

      <div class="content">
        <!-- Timeline -->
        <div class="card">
          <div class="timeline" id="timeline">
            <div class="node"><div class="dot"></div><div class="muted">Placed</div></div>
            <div class="bar"></div>
            <div class="node"><div class="dot"></div><div class="muted">Paid</div></div>
            <div class="bar"></div>
            <div class="node"><div class="dot"></div><div class="muted">Packed</div></div>
            <div class="bar"></div>
            <div class="node"><div class="dot"></div><div class="muted">Shipped</div></div>
            <div class="bar"></div>
            <div class="node"><div class="dot"></div><div class="muted">Delivered</div></div>
          </div>
        </div>

        <div class="grid cols-2">
          <!-- Left: Customer + Items -->
          <div class="grid" style="gap:12px">
            <div class="card">
              <div class="kv"><div class="muted">Customer</div><div class="value" id="c_name">‚Äî</div></div>
              <div class="kv"><div class="muted">Phone</div><div id="c_phone">‚Äî</div></div>
              <div class="kv"><div class="muted">Email</div><div id="c_email">‚Äî</div></div>
              <div class="kv"><div class="muted">Ship To</div><div id="c_address">‚Äî</div></div>
              <div class="divider"></div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn tiny ghost" id="btnViewCustomer">üë§ View Customer</button>
                <button class="btn tiny ghost" id="btnCopyAddress">üìã Copy Address</button>
              </div>
            </div>

            <div class="card">
              <table class="table" id="itemsTable" aria-label="Order items">
                <thead><tr><th>Product</th><th>Qty</th><th class="right">Price</th><th class="right">Total</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Right: Summary + Payment + Shipping + Notes -->
          <div class="grid" style="gap:12px">
            <div class="card">
              <div class="kv"><div class="muted">Order ID</div><div class="value" id="o_id">‚Äî</div></div>
              <div class="kv"><div class="muted">Date</div><div id="o_date">‚Äî</div></div>
              <div class="kv"><div class="muted">Payment</div><div id="o_payment">‚Äî</div></div>
              <div class="kv"><div class="muted">Status</div><div id="o_status">‚Äî</div></div>
              <div class="kv"><div class="muted">Note</div><div id="o_note">‚Äî</div></div>
              <div class="divider"></div>
              <div class="row"><span>Subtotal</span><b id="t_sub">Rp 0</b></div>
              <div class="row"><span>Discount</span><b id="t_disc">Rp 0</b></div>
              <div class="row"><span>Tax</span><b id="t_tax">Rp 0</b></div>
              <div class="row lg"><span>Total</span><b class="xl" id="t_total">Rp 0</b></div>
            </div>

            <div class="card">
              <div class="kv"><div class="muted">Payment Method</div><div id="p_method">‚Äî</div></div>
              <div class="kv"><div class="muted">Payment Ref</div><div id="p_ref">‚Äî</div></div>
              <div class="divider"></div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
               {#  <button class="btn tiny ok" id="btnMarkPaid">‚úî Mark as Paid</button>
                <button class="btn tiny warn" id="btnRefund">‚Ü© Refund</button> #}
              </div>
            </div>

            <div class="card">
              <div class="kv"><div class="muted">Shipping Method</div><div id="s_method">‚Äî</div></div>
              <div class="kv"><div class="muted">Tracking</div><div id="s_track">‚Äî</div></div>
              <div class="kv"><div class="muted">ETA</div><div id="s_eta">‚Äî</div></div>
              <div class="divider"></div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
              {#   <button class="btn tiny" id="btnMarkShipped">üì¶ Mark as Shipped</button>
                <button class="btn tiny ghost" id="btnCopyTracking">üìã Copy Tracking</button> #}
              </div>
            </div>

            <div class="card">
              <div class="muted" style="margin-bottom:6px">Admin Notes</div>
              <textarea id="adminNotes" class="inp" rows="3" placeholder="Add internal notes (not visible to customer)"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px">
                {# <button class="btn tiny ghost" id="btnSaveNotes">üíæ Save Notes</button> #}
              </div>
            </div>
          </div>
        </div>

        <!-- Footer Bar -->
        <div class="footerbar">
          <button class="btn ghost tiny" data-order="0" id="btnFooterInvoice">üßæ Print Invoice</button>
          <button class="btn ghost tiny" data-order="0" id="btnFooterReceipt">üßæ Print Receipt</button>
         {#  <button class="btn ok tiny" id="btnFooterPaid">‚úî Mark Paid</button>
          <button class="btn tiny" id="btnFooterShipped">üì¶ Mark Shipped</button>
          <button class="btn warn tiny" id="btnFooterRefund">‚Ü© Refund</button> #}
        </div>
      </div>
    </div>
  </div>

  <link rel="stylesheet" href="catalog/view/theme/default/stylesheet/bpos/drawer.css?v={{ random() }}">
  <link rel="stylesheet" href="catalog/view/theme/default/stylesheet/bpos/order.css?v={{ random() }}">
  <script>
$(function () {
  // --- Mock Data ------------------------------------------------------------
  const STORES = [
    {code:'all', name:'All Stores', channel:'Online'},
    {code:'hej', name:'HejOrganic.id', channel:'Online'},
    {code:'puserba-jkt', name:'Puserba ‚Äì Outlet Jakarta', channel:'POS'},
    {code:'puserba-bdg', name:'Puserba ‚Äì Outlet Bandung', channel:'POS'},
//    {code:'shopee', name:'Shopee', channel:'Marketplace'},
//    {code:'tokopedia', name:'Tokopedia', channel:'Marketplace'}
  ];

  const STATUS = ['Paid','Pending','Shipped','Completed','Cancelled'];
  const PAYMENT = ['QRIS','Cash','Transfer','COD'];
  const CASHIERS = ['Rina','Adi','Budi'];

  const rnd = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const pick = arr => arr[rnd(0,arr.length-1)];
  const today = new Date();
  const fmtIDR = v=> new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(v);
  const fmtDate = d=> new Date(d).toLocaleString('id-ID',{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});

  // Generate 150 sample orders within last 30 days
    let ORDERS = [];

  // --- State ---------------------------------------------------------------
  const state = {
    stores:new Set(),
    datePreset:'thisweek',
    from:null,
    to:null,
    status:'',
    payment:'',
    channel:'',
    cashier:'',
    q:'',
  };

  // Restore state from localStorage
  const saveKey = 'bpos.order.filters.v1';
  const saved = localStorage.getItem(saveKey);
  if(saved){
    try{
      const s = JSON.parse(saved);
      Object.assign(state, s, {stores:new Set(s.stores||[])});
    }catch(e){}
  }

  // --- Cache jQuery selectors ----------------------------------------------
  const $fStore   = $('#fStore');
  const $fDate    = $('#fDate');
  const $fFrom    = $('#fFrom');
  const $fTo      = $('#fTo');
  const $fStatus  = $('#fStatus');
  const $fPayment = $('#fPayment');
  const $fChannel = $('#fChannel');
  const $fCashier = $('#fCashier');
  const $search   = $('#searchBox');

  const $tbody         = $('#tbody');
  const $summaryChips  = $('#summaryChips');
  const $mOrders       = $('#mOrders');
  const $mRevenue      = $('#mRevenue');
  const $mTopStores    = $('#mTopStores');
  const $spark         = $('#spark');
  const $activePills   = $('#activePills');
  const $btnExport     = $('#btnExport');
  const $btnRefresh    = $('#btnRefresh');
  const $autoRefresh   = $('#autoRefresh');

  // --- Init UI -------------------------------------------------------------
  // Populate store options
  $.each(STORES, function(_, s){
    $('<option/>', {value:s.code, text:s.name}).appendTo($fStore);
  });
  // Preselect from state (multiselect)
  if(state.stores.size){
    $fStore.val([...state.stores]);
  }

  $fDate.val(state.datePreset || 'thisweek');
  $fStatus.val(state.status);
  $fPayment.val(state.payment);
  $fChannel.val(state.channel);
  $fCashier.val(state.cashier);
  $search.val(state.q || '');
  if(state.from) $fFrom.val(state.from);
  if(state.to) $fTo.val(state.to);

  // Date inputs when custom
  function toggleCustomDates() {
    const isCustom = $fDate.val()==='custom';
    $fFrom.toggleClass('hide', !isCustom);
    $fTo.toggleClass('hide', !isCustom);
    $('#tilde').toggleClass('hide', !isCustom);
  }
  toggleCustomDates();

  // --- Filtering -----------------------------------------------------------
  function inRange(iso) {
    const d = new Date(iso);
    const preset = state.datePreset;
    const start = new Date();
    const end = new Date();
    end.setHours(23,59,59,999);

    if(preset==='today'){
      start.setHours(0,0,0,0);
    } else if(preset==='yesterday'){
      start.setDate(start.getDate()-1); start.setHours(0,0,0,0);
      end.setDate(end.getDate()-1);
    } else if(preset==='thisweek'){
      const day = start.getDay(); // 0 Sun
      const diff = (day===0?6:day-1); // Monday start
      start.setDate(start.getDate()-diff); start.setHours(0,0,0,0);
    } else if(preset==='thismonth'){
      start.setDate(1); start.setHours(0,0,0,0);
    } else if(preset==='custom'){
      if(state.from && state.to){
        return d >= new Date(state.from) && d <= new Date(new Date(state.to).setHours(23,59,59,999));
      }
      return true;
    }
    return d>=start && d<=end;
  }

  function matches(o){
    if(state.stores.size && !state.stores.has(o.storeCode)) return false;
    if(state.status && o.status!==state.status) return false;
    if(state.payment && o.payment!==state.payment) return false;
    if(state.channel && o.channel!==state.channel) return false;
    if(state.cashier && o.cashier!==state.cashier) return false;
    if(!inRange(o.date)) return false;
    if(state.q){
      const q=state.q.toLowerCase();
      if(!(o.id.toLowerCase().includes(q) || (o.customer||'').toLowerCase().includes(q))) return false;
    }
    return true;
  }

  // --- Render --------------------------------------------------------------
  function renderTable(){
    const rows = ORDERS.filter(matches);
    const html = $.map(rows, function(o){
      const sClass = {
        'Paid':'s-paid','Pending':'s-pending','Shipped':'s-shipped','Completed':'s-completed','Cancelled':'s-cancelled'
      }[o.status]||'';
      return `
        <tr data-id="${o.id}">
          <td><input type="checkbox" aria-label="select ${o.id}"></td>
          <td><b>${o.id}</b><div class="tiny">${o.items} items</div></td>
          <td>${o.customer}</td>
          <td>${o.store}</td>
          <td class="tiny">${fmtDate(o.date)}</td>
          <td><span class="status ${sClass}">${o.status}</span></td>
          <td class="nowrap"><b>${fmtIDR(o.total)}</b></td>
          <td>${o.payment}</td>
          <td>${o.channel}</td>
          <td class="actions">
            <button class="icon-btn" data-act="view" title="View detail">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/></svg>
            </button>
            <button class="icon-btn" data-act="menu" title="More">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            </button>
          </td>
        </tr>`;
    }).join('');
    $tbody.html(html);

    // Summary chips
    const totalOrders = rows.length;
    const revenue = rows.reduce((a,b)=>a+b.total,0);
    $summaryChips.html(`
      <span class="chip"><b>${totalOrders}</b> Orders</span>
      <span class="chip"><b>${fmtIDR(revenue)}</b> Revenue</span>
    `);

    // Metrics
    $mOrders.text(totalOrders);
    $mRevenue.text(fmtIDR(revenue));

    // Top stores
    const byStore = new Map();
    rows.forEach(r=>byStore.set(r.store,(byStore.get(r.store)||0)+r.total));
    const top = [...byStore.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3);
    $mTopStores.html(top.length ? top.map(([name,val])=>`<div>${name}: <b>${fmtIDR(val)}</b></div>`).join('') : '<span class="tiny">‚Äî</span>');

    // Sparkline
    drawSpark(rows);
  }

  function drawSpark(rows){
    const days=7; const now=new Date();
    const buckets = Array.from({length:days},(_,i)=>{const d=new Date(); d.setDate(now.getDate()-(days-1-i)); d.setHours(0,0,0,0); return {d, v:0};});
    rows.forEach(r=>{
      const rd = new Date(r.date); rd.setHours(0,0,0,0);
      const idx = buckets.findIndex(b=>b.d.getTime()===rd.getTime());
      if(idx>-1) buckets[idx].v += r.total;
    });
    const max = Math.max(1,...buckets.map(b=>b.v));
    const pts = buckets.map((b,i)=>{
      const x = (i/(days-1))*100;
      const y = 30 - (b.v/max)*26 - 2; // padding
      return `${x},${y}`;
    }).join(' ');
    $spark.html(`<polyline points="${pts}" fill="none" stroke="#1e3a8a" stroke-width="2"/><circle r="2" cx="100" cy="${30 - (buckets[days-1].v/Math.max(1,max))*26 - 2}" fill="#1e3a8a"/>`);
  }

  function renderPills(){
    const pills = [];
    if(state.stores.size) pills.push({type:'store',   label:'Store',  value:[...state.stores].map(c=>STORES.find(s=>s.code===c)?.name||c).join(', ')});
    if(state.status)       pills.push({type:'status',  label:'Status', value:state.status});
    if(state.payment)      pills.push({type:'payment', label:'Payment',value:state.payment});
    if(state.channel)      pills.push({type:'channel', label:'Channel',value:state.channel});
    if(state.cashier)      pills.push({type:'cashier', label:'Cashier',value:state.cashier});
    if(state.datePreset!=='thisweek'){
      pills.push({type:'date', label:'Date', value: state.datePreset==='custom' ? ((state.from||'?')+' to '+(state.to||'?')) : state.datePreset});
    }
    if(state.q)            pills.push({type:'search', label:'Search', value:state.q});

    const html = pills.map((p,i)=>`<span class="pill" data-type="${p.type}">
      <b>${p.label}:</b> ${p.value} <button aria-label="remove ${p.label}">√ó</button>
    </span>`).join('');
    $activePills.html(html);
  }

  function persist(){
    const plain = {...state, stores:[...state.stores]};
    localStorage.setItem(saveKey, JSON.stringify(plain));
  }

  // --- Bindings ------------------------------------------------------------
  $fStore.on('change', function(){
    const vals = $(this).find('option:selected').map(function(){return this.value;}).get();
    state.stores = new Set(vals);
    persist(); renderPills(); renderTable();
  });

  $fDate.on('change', function(){
    state.datePreset = $(this).val();
    toggleCustomDates(); persist(); renderPills(); renderTable();
  });

  $fFrom.on('change', function(){ state.from = $(this).val(); persist(); renderPills(); renderTable(); });
  $fTo.on('change',   function(){ state.to   = $(this).val(); persist(); renderPills(); renderTable(); });

  $fStatus.on('change',  function(){ state.status  = $(this).val(); persist(); renderPills(); renderTable(); });
  $fPayment.on('change', function(){ state.payment = $(this).val(); persist(); renderPills(); renderTable(); });
  $fChannel.on('change', function(){ state.channel = $(this).val(); persist(); renderPills(); renderTable(); });
  $fCashier.on('change', function(){ state.cashier = $(this).val(); persist(); renderPills(); renderTable(); });

  $search.on('input', function(){
    state.q = $(this).val().trim();
    persist(); renderPills(); renderTable();
  });

  // Active pills remove (delegated)
  $activePills.on('click', '.pill button', function(){
    const type = $(this).closest('.pill').data('type');
    switch(type){
      case 'store':
        state.stores.clear();
        $fStore.val([]); // clear multiselect
        break;
      case 'status':
        state.status = '';
        $fStatus.val('');
        break;
      case 'payment':
        state.payment = '';
        $fPayment.val('');
        break;
      case 'channel':
        state.channel = '';
        $fChannel.val('');
        break;
      case 'cashier':
        state.cashier = '';
        $fCashier.val('');
        break;
      case 'date':
        state.datePreset = 'thisweek';
        $fDate.val('thisweek');
        toggleCustomDates();
        break;
      case 'search':
        state.q = '';
        $search.val('');
        break;
    }
    persist(); renderPills(); renderTable();
  });

  // Export Excel
$btnExport.on('click', function () {
    const rows = ORDERS.filter(matches);

    let html = `
      <table border="1">
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Store</th>
          <th>Date</th>
          <th>Status</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Channel</th>
        </tr>
    `;

    rows.forEach(o => {
        html += `
          <tr>
            <td>${o.id}</td>
            <td>${o.customer}</td>
            <td>${o.store}</td>
            <td>${fmtDate(o.date)}</td>
            <td>${o.status}</td>
            <td>${o.total}</td>
            <td>${o.payment}</td>
            <td>${o.channel}</td>
          </tr>
        `;
    });

    html += `</table>`;

    const blob = new Blob([html], { 
        type: "application/vnd.ms-excel"
    });

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "orders.xls";
    a.click();
    URL.revokeObjectURL(a.href);
});


  // Table actions (delegated)
  $(document).on('click', '[data-act="view"], #tbody td:not(.actions)', function () {
    const id = $(this).closest('tr').data('id');
    $.getJSON('index.php?route=bpos/order/view&order_id=' + id + '&format=json', function (order) {
      openDrawer(order);
    });
  });

  // Refresh (simulated)
  function refresh(){ renderTable(); }
  $btnRefresh.on('click', refresh);

  let timer = setInterval(function(){
    if($autoRefresh.is(':checked')) refresh();
  }, 30000);

  $autoRefresh.on('change', function(){
    if($(this).is(':checked')) refresh();
  });
  function cellText(col) {
  if (col == null) return '';
  col = String(col);
  // kalau mengandung tag HTML, parse sebagai HTML
  if (col.indexOf('<') !== -1 && col.indexOf('>') !== -1) {
    return $('<div>').html(col).text();
  }
  // kalau cuma teks biasa, langsung pakai
  return col;
}
  function loadOrders() {
    $('#tbody').html('<tr><td colspan="10" class="center tiny">Loading orders...</td></tr>');
    const params = {
      filter_status_id: $('#fStatus').val() || '',
      filter_payment: $('#fPayment').val() || '',
      filter_date_start: $('#fFrom').val() || '',
      filter_date_end: $('#fTo').val() || ''
    };
    $.ajax({
      url: 'index.php?route=bpos/order/getlist',
      data: params,
      dataType: 'json',
      success: function (res) {
        ORDERS = (res.data || []).map(row => ({
          id: cellText(row[1]).replace('#', ''),
          customer: cellText(row[2]),
          status: cellText(row[3]),
          total: parseFloat(cellText(row[4])) || 0,
          date: cellText(row[5]),
          items: Number(row[6] || 0),        // <---- FIX ITEMS
          payment: cellText(row[7]),
          channel: 'POS',
          store: 'Main Store'
        }));
        renderTable();
      },
      error: function () {
        $('#tbody').html('<tr><td colspan="10" class="center tiny text-red">Failed to load orders</td></tr>');
      }
    });
  }

  // Initial render
  renderPills();
  renderTable();
  loadOrders();
});
</script>

<script>

const sampleOrder = {
  id: 'INV-20251029-001',
  date: '2025-10-29 10:15',
  status: 'Paid',
  customer: { name:'Ayu Lestari', phone:'+62822-3333-4444', email:'ayu@example.com', address:'Gianyar, Bali' },
  items: [
    {name:'Organic Granola 500g', qty:2, price:85000},
    {name:'Almond Milk 1L', qty:1, price:54000},
    {name:'Reusable Bag', qty:1, price:15000}
  ],
  discounts: 10000,
  tax: 12000,
  payment: { method:'QRIS', ref:'QR987654321' },
  shipping: { method:'JNE REG', tracking:'JNE123456789', eta:'2025-10-31' },
  note:'Deliver in the morning if possible.'
};

function sum(items){ return items.reduce((a,i)=> a + (i.qty*i.price), 0); }

function setStatusBadge(el, status){
  const map = { Paid:'ok', Pending:'warn', Cancelled:'bad', Refunded:'warn', Shipped:'info', Delivered:'info' };
  el.className = 'badge ' + (map[status] || 'info');
  el.textContent = status;
}

function setTimeline(status){
  const stages = ['Placed','Paid','Packed','Shipped','Delivered'];
  const idx = { 'Placed':0,'Pending':0,'Paid':1,'Packed':2,'Shipped':3,'Delivered':4,'Cancelled':0,'Refunded':1 }[status] ?? 0;
  const nodes = document.querySelectorAll('#timeline .node');
  nodes.forEach((n,i)=> n.classList.toggle('active', i <= idx));
}

function fillOrder(o){
  // Header
  $('#drawerTitle').text('Order #' + o.id);
  setStatusBadge(document.getElementById('orderStatusBadge'), o.status);
  setTimeline(o.status);

  // Set all button order-id

  $('#btnPrintInvoice').data('order', o.id);
  $('#btnPrintReceipt').data('order', o.id);
  $('#btnFooterInvoice').data('order', o.id);
  $('#btnFooterReceipt').data('order', o.id);

  // Customer box
  $('#c_name').text(o.customer.name);
  $('#c_phone').text(o.customer.phone);
  $('#c_email').text(o.customer.email);
  $('#c_address').text(o.customer.address);

  // Items
  const $tb = $('#itemsTable tbody').empty();
  o.items.forEach(it=>{
    const line = it.qty*it.price;
    $tb.append(`<tr>
      <td>${it.name}</td>
      <td>${it.qty}</td>
      <td class="right money">${money(it.price)}</td>
      <td class="right money">${money(line)}</td>
    </tr>`);
  });

  // Totals
  const sub = sum(o.items);
  $('#o_id').text(o.id);
  $('#o_date').text(o.date);
  $('#o_payment').text(o.payment.method);
  $('#o_status').text(o.status);
  $('#o_note').text(o.note||'‚Äî');
  $('#t_sub').text(money(sub));
  $('#t_disc').text('- ' + money(o.discounts));
  $('#t_tax').text(money(o.tax));
  $('#t_total').text(money(sub - o.discounts + o.tax));

  // Payment block
  $('#p_method').text(o.payment.method);
  $('#p_ref').text(o.payment.ref);

  // Shipping block
  $('#s_method').text(o.shipping.method);
  $('#s_track').text(o.shipping.tracking);
  $('#s_eta').text(o.shipping.eta);

  // Print (Invoice)
  $('#pi_id').text(o.id);
  $('#pi_date').text(o.date);
  $('#pi_status').text('Status: ' + o.status);
  $('#pi_name').text(o.customer.name);
  $('#pi_addr').text(o.customer.address);
  $('#pi_phone').text(o.customer.phone);
  const $pi = $('#pi_items').empty();
  o.items.forEach(it=>{
    const line = it.qty*it.price;
    $pi.append(`<tr><td>${it.name}</td><td align="right">${it.qty}</td><td align="right">${money(it.price)}</td><td align="right">${money(line)}</td></tr>`);
  });
  $('#pi_sub').text(money(sub));
  $('#pi_disc').text('- ' + money(o.discounts));
  $('#pi_tax').text(money(o.tax));
  $('#pi_total').text(money(sub - o.discounts + o.tax));

  // Print (Receipt)
  $('#pr_id').text(o.id);
  $('#pr_date').text(o.date);
  $('#pr_name').text(o.customer.name);
  const $pr = $('#pr_items').empty();
  o.items.forEach(it=>{
    const line = it.qty*it.price;
    $pr.append(`<tr><td>${it.name} √ó ${it.qty}</td><td align="right">${money(line)}</td></tr>`);
  });
  $('#pr_total').text(money(sub - o.discounts + o.tax));
}

function openDrawer(order){
  $('#drawer').addClass('open').attr('aria-hidden','false');
  fillOrder(order);
}
function closeDrawer(){ $('#drawer').removeClass('open').attr('aria-hidden','true'); }

function printArea(areaId){
  // Show the print area and trigger window.print(); CSS handles visibility
  const el = document.getElementById(areaId);
  if(!el){ toast('Printable area not found','error'); return; }
  const prevTitle = document.title;
  document.title = areaId === 'print-invoice' ? ('Invoice ' + $('#o_id').text()) : ('Receipt ' + $('#o_id').text());
  window.print();
  document.title = prevTitle;
}

$(function(){
  // Open sample
  $('#btnNew').on('click', ()=> loadContent('bpos/home'));

  // Close
  $(document).on('click','[data-close]', closeDrawer);
  $('.backdrop').on('click', function(e){ if(e.target===this) closeDrawer(); });

  // Actions
  $('#btnPrintInvoice, #btnFooterInvoice').on('click', function(){
    const orderId = $(this).data('order');
    console.log('Print invoice for order:', orderId);
    window.location.href = 'index.php?route=bpos/invoice&order_id='+orderId;
  });
  $('#btnPrintReceipt, #btnFooterReceipt').on('click', function(){
    const orderId = $(this).data('order');
    window.location.href = 'index.php?route=bpos/invoice&order_id='+orderId;
  });
  $('#btnSendEmail').on('click', ()=> toast('Invoice sent to ' + sampleOrder.customer.email));
  $('#btnLabel').on('click', ()=> toast('Shipping label generated'));
  $('#btnCancel').on('click', ()=> {
    if(confirm('Cancel this order?')){
      sampleOrder.status='Cancelled';
      fillOrder(sampleOrder);
      toast('Order cancelled','error');
    }
  });

  // Payment & Shipping quick actions
  const markPaid = ()=>{
    sampleOrder.status='Paid';
    fillOrder(sampleOrder);
    toast('Order marked as Paid');
  };
  const markShipped = ()=>{
    sampleOrder.status='Shipped';
    fillOrder(sampleOrder);
    toast('Order marked as Shipped');
  };
  const refund = ()=>{
    if(confirm('Confirm refund?')){
      sampleOrder.status='Refunded';
      fillOrder(sampleOrder);
      toast('Order refunded','warn');
    }
  };

  $('#btnMarkPaid, #btnFooterPaid').on('click', markPaid);
  $('#btnMarkShipped, #btnFooterShipped').on('click', markShipped);
  $('#btnRefund, #btnFooterRefund').on('click', refund);

  // Utilities
  $('#btnCopyAddress').on('click', ()=> { navigator.clipboard.writeText(sampleOrder.customer.address); toast('Address copied'); });
  $('#btnCopyTracking').on('click', ()=> { navigator.clipboard.writeText(sampleOrder.shipping.tracking); toast('Tracking copied'); });
  $('#btnViewCustomer').on('click', ()=> toast('Open customer drawer for ' + sampleOrder.customer.name));

  // Notes
  $('#btnSaveNotes').on('click', ()=> toast('Notes saved'));
});
</script>

