<div class="container settings">
  <div class="card">
    <div class="header" style="padding:16px 16px 0 16px">
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M5 7h14l-1 12H6L5 7Z" stroke="#1b5fb3" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M9 7V5a3 3 0 0 1 6 0v2" stroke="#1b5fb3" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <h1>Settings - {{ title }}</h1>
        <span class="badge dot" id="status-badge">Online</span>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btn-docs">ðŸ“– Documentation</button>
        <button class="btn ghost" id="btn-ticket">ðŸŽ« Support Ticket</button>
        <button class="btn" id="btn-test">ðŸ”„ Test Connection</button>
      </div>
    </div>

    <nav class="tabs" role="tablist" aria-label="BPOS Settings Tabs">
      <button role="tab" aria-selected="true" data-tab="general">{{ text_general }}</button>
      <button role="tab" aria-selected="false" data-tab="store">{{ text_store }}</button>
      <button role="tab" aria-selected="false" data-tab="device">{{ text_device }}</button>
      <button role="tab" aria-selected="false" data-tab="cashier">{{ text_cashier }}</button>
      <button role="tab" aria-selected="false" data-tab="users">{{ text_users }}</button>
      <button role="tab" aria-selected="false" data-tab="sales">{{ text_sales }}</button>
      <button role="tab" aria-selected="false" data-tab="advanced">{{ text_advanced }}</button>
      <button role="tab" aria-selected="false" data-tab="help">{{ text_help }}</button>
    </nav>

    {# panels diambil dari file html, bisa dipotong sesuai kebutuhan #}
    <section class="panel" id="panel-general">
  <div class="grid">
  <div class="field">
    <label for="setting_status">Module Status</label>
    <div class="row">
      <div class="toggle {{ settings.setting_bpos_status ? 'on' : '' }}"
           data-bind="status"><i></i></div>
      <span>Enable / Disable module</span>
    </div>
  </div>

  <!-- WhatsApp Number -->
  <div class="field">
    <label for="whatsapp_number">WhatsApp Number</label>
    <div class="row" style="gap:8px; align-items:center;">
      <span class="kbd" id="country-code">62</span>
      <input id="whatsapp_number" name="whatsapp_number" type="text"
             value="{{ settings.setting_bpos_whatsapp_number ?? '' }}"
             placeholder="812xxxxxx">
    </div>
    <input type="hidden" name="country_code" value="{{ settings.setting_bpos_country_code ?? '62' }}">
  </div>

  <!-- Shipping Methods -->
  <div class="field">
    <label>Shipping Methods</label>
    <div class="well-sm" style="max-height:160px; overflow:auto; padding:10px; background:#fafafa; border:1px solid #ddd;">
      {% for method in delivery_methods %}
        <label class="checkbox" style="display:block; margin-bottom:6px;">
          <input type="checkbox"
                 name="shipping_methods[]"
                 value="{{ method.code }}"
                 {{ method.code in settings.setting_bpos_shipping_methods ? 'checked' }}>
          {{ method.title }}
        </label>
      {% endfor %}
    </div>
  </div>

  <!-- Payment Methods -->
  <div class="field">
    <label>Payment Methods</label>
    <div class="well-sm" style="max-height:160px; overflow:auto; padding:10px; background:#fafafa; border:1px solid #ddd;">
      {% for method in pay_methods %}
        <label class="checkbox" style="display:block; margin-bottom:6px;">
          <input type="checkbox"
                 name="payment_methods[]"
                 value="{{ method.code }}"
                 {{ method.code in settings.setting_bpos_payment_methods ? 'checked' }}>
          {{ method.title }}
        </label>
      {% endfor %}
    </div>
  </div>

  <!-- Payment Gateway -->
  <div class="field">
    <label>Payment Gateway</label>
    <div class="well-sm" style="max-height:160px; overflow:auto; padding:10px; background:#fafafa; border:1px solid #ddd;">
      {% for method in pay_methods %}
        <label class="checkbox" style="display:block; margin-bottom:6px;">
          <input type="checkbox"
                 name="payment_gateway[]"
                 value="{{ method.code }}"
                 {{ method.code in settings.setting_bpos_payment_gateway ? 'checked' }}>
          {{ method.title }}
        </label>
      {% endfor %}
    </div>
  </div>

  <!-- Default Shipping Method -->
  <div class="field">
    <label for="default_shipping_method">Default Shipping Method</label>
    <select id="default_shipping_method"
            name="default_shipping_method">
      {% for method in delivery_methods %}
        <option value="{{ method.code }}"
          {{ method.code == settings.setting_bpos_default_shipping_method ? 'selected' }}>
          {{ method.title }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- Default Payment Method -->
  <div class="field">
    <label for="default_payment_method">Default Payment Method</label>
    <select id="default_payment_method"
            name="default_payment_method">
      {% for method in pay_methods %}
        <option value="{{ method.code }}"
          {{ method.code == settings.setting_bpos_default_payment_method ? 'selected' }}>
          {{ method.title }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- Complete Order Status -->
  <div class="field">
    <label for="complete_order_status">Complete Order Status</label>
    <select id="complete_order_status"
            name="complete_order_status">
      {% for os in order_statuses %}
        <option value="{{ os.order_status_id }}"
          {{ os.order_status_id == settings.setting_bpos_complete_order_status ? 'selected' }}>
          {{ os.name }}
        </option>
      {% endfor %}
    </select>
  </div>

    <div class="field">
      <label for="pos_name">POS Display Name</label>
      <input id="pos_name" name="pos_name" type="text"
             value="{{ settings.setting_bpos_pos_name ?? '' }}">
    </div>

    <div class="field">
      <label for="pos_path">POS URL Path</label>
      <input id="pos_path" name="pos_path" type="text"
             value="{{ settings.setting_bpos_pos_path ?? '/pos' }}">
    </div>

    <div class="field">
      <label for="currency">Default Currency</label>
      <select id="currency" name="currency">
        {% for cur in currencies %}
          <option value="{{ cur.code }}"
            {{ cur.code == settings.setting_bpos_currency ? 'selected' }}>
            {{ cur.code }} â€” {{ cur.title }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label for="timezone">Timezone</label>
      <select id="timezone" name="timezone">
        <option value="Asia/Jakarta" {{ settings.setting_bpos_timezone=='Asia/Jakarta'?'selected':'' }}>Asia/Jakarta</option>
        <option value="Asia/Singapore" {{ settings.setting_bpos_timezone=='Asia/Singapore'?'selected':'' }}>Asia/Singapore</option>
        <option value="Pacific/Auckland" {{ settings.setting_bpos_timezone=='Pacific/Auckland'?'selected':'' }}>Pacific/Auckland</option>
      </select>
    </div>

    <div class="field">
      <label>Date Format</label>
      <select id="date_format" name="date_format">
        <option value="YYYY-MM-DD" {{ settings.setting_bpos_date_format=='YYYY-MM-DD'?'selected':'' }}>YYYY-MM-DD</option>
        <option value="DD/MM/YYYY" {{ settings.setting_bpos_date_format=='DD/MM/YYYY'?'selected':'' }}>DD/MM/YYYY</option>
        <option value="MM/DD/YYYY" {{ settings.setting_bpos_date_format=='MM/DD/YYYY'?'selected':'' }}>MM/DD/YYYY</option>
      </select>
    </div>

    <div class="field">
      <label>Theme</label>
      <div class="row">
        <div class="toggle {{ settings.setting_bpos_darkmode?'on':'' }}" data-bind="darkmode"><i></i></div>
        <span>Enable Dark Mode</span>
      </div>
    </div>

    <div class="field">
      <label>Offline Mode</label>
      <div class="row">
        <div class="toggle {{ settings.setting_bpos_offline?'on':'' }}" data-bind="offline"><i></i></div>
        <span>Allow offline mode</span>
      </div>
    </div>

    <div class="field">
      <label>Dashboard View</label>
      <select id="dashboard_view" name="dashboard_view">
        <option value="today" {{ settings.setting_bpos_dashboard_view=='today'?'selected':'' }}>Today</option>
        <option value="week" {{ settings.setting_bpos_dashboard_view=='week'?'selected':'' }}>This Week</option>
        <option value="month" {{ settings.setting_bpos_dashboard_view=='month'?'selected':'' }}>This Month</option>
        <option value="custom" {{ settings.setting_bpos_dashboard_view=='custom'?'selected':'' }}>Custom</option>
      </select>
    </div>

  </div>
</section>

   <section class="panel" id="panel-store" hidden>
  <div class="grid">

    <div class="field">
      <label>Store Selection</label>
      <select id="store_id" name="store_id">
        {% for store in stores %}
          <option value="{{ store.store_id }}"
            {{ store.store_id == settings.setting_bpos_store_id ? 'selected' }}>
            {{ store.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label>Languages</label>

      <div class="lang-pills">
        {% for lang in languages %}
          <button class="pill {{ loop.first?'active':'' }}"
                  aria-selected="{{ loop.first?'true':'false' }}"
                  data-lang="{{ lang.code }}">
            {{ lang.code|upper }}
          </button>
        {% endfor %}
      </div>

      <div class="hr"></div>

      {% for lang in languages %}
        <div class="lang-group {{ loop.first?'active':'' }}" data-group="{{ lang.code }}">

          <div class="field">
            <label>POS Title ({{ lang.code|upper }})</label>
            <input type="text" name="title_{{ lang.language_id }}"
                   value="{{ settings['setting_bpos_title_' ~ lang.language_id] ?? '' }}">
          </div>

          <div class="field">
            <label>Receipt Header ({{ lang.code|upper }})</label>
            <textarea name="header_{{ lang.language_id }}">{{ settings['setting_bpos_header_' ~ lang.language_id] ?? '' }}</textarea>
          </div>

        </div>
      {% endfor %}
    </div>

    <div class="field">
      <label>Tax Included</label>
      <div class="row">
        <div class="toggle {{ settings.setting_bpos_tax_included?'on':'' }}" data-bind="tax_included"><i></i></div>
        <span>Prices include tax</span>
      </div>
    </div>

    <div class="field">
      <label>Rounding</label>
      <div class="split">
        <div class="row">
          <div class="toggle {{ settings.setting_bpos_rounding?'on':'' }}" data-bind="rounding"><i></i></div>
          <span>Enable rounding</span>
        </div>
        <input id="round_precision" name="round_precision" type="number"
               value="{{ settings.setting_bpos_round_precision ?? 0 }}">
      </div>
    </div>

  </div>
</section>
  
  <section class="panel" id="panel-device" hidden>
  <div class="grid">

    <div class="field">
      <label>Device ID</label>
      <select id="device_id" name="device_id">
        <option value="">Auto (Browser)</option>
        {% for dev in oc.devices %}
          <option value="{{ dev.code }}"
            {{ dev.code == settings.setting_bpos_device_id ? 'selected' }}>
            {{ dev.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label>Barcode Scanner</label>
      <div class="row">
        <div class="toggle {{ settings.setting_bpos_scanner?'on':'' }}" data-bind="scanner"><i></i></div>
        <span>Enable barcode input</span>
      </div>
    </div>

    <div class="field">
      <label>Receipt Printer</label>
      <select id="printer" name="printer">
        <option value="none" {{ settings.setting_bpos_printer=='none'?'selected':'' }}>â€” Not Connected â€”</option>
        <option value="thermal-58" {{ settings.setting_bpos_printer=='thermal-58'?'selected':'' }}>Thermal 58mm</option>
        <option value="thermal-80" {{ settings.setting_bpos_printer=='thermal-80'?'selected':'' }}>Thermal 80mm</option>
        <option value="a4" {{ settings.setting_bpos_printer=='a4'?'selected':'' }}>A4 Printer</option>
      </select>

      <div class="hint">
        Auto Print
        <span class="row">
          <div class="toggle {{ settings.setting_bpos_autoprint?'on':'' }}" data-bind="autoprint"><i></i></div>
        </span>
      </div>
    </div>

    <div class="field">
      <label>Print Logo</label>
      <input type="text" id="print_logo" name="print_logo"
             value="{{ settings.setting_bpos_print_logo ?? '' }}">
    </div>

    <div class="field">
      <label>Receipt Footer</label>
      <textarea id="receipt_footer" name="receipt_footer">{{ settings.setting_bpos_receipt_footer ?? '' }}</textarea>
    </div>

  </div>
</section>

<section class="panel" id="panel-cashier" hidden>
  <div class="grid">

    <div class="field">
      <label>Default Role</label>
      <select id="role_default" name="role_default">
        <option value="admin" {{ settings.setting_bpos_role_default=='admin'?'selected':'' }}>Admin</option>
        <option value="staff" {{ settings.setting_bpos_role_default=='staff'?'selected':'' }}>Staff</option>
      </select>
    </div>

    <div class="field">
      <label>Session Timeout (Hours)</label>
      <input id="session_timeout" name="session_timeout" type="number"
             value="{{ settings.setting_bpos_session_timeout ?? 1 }}">
    </div>

    <div class="field">
      <label>Permissions</label>
      <div class="note" id="perm-box"></div>
    </div>

  </div>
</section>

<section class="panel" id="panel-users" hidden>
        <div class="field">
          <label class="section-title">POS Users</label>
          <div class="toolbar">
            <div class="search">
              <input id="user-search" type="text" placeholder="Search username or role">
              <button class="btn small" id="user-search-clear">Clear</button>
            </div>
            <div class="right">
              <span class="badge-sm muted" id="user-count">0 users</span>
              <button class="btn primary" id="btn-add-user">+ New User</button>
            </div>
          </div>
          <table class="table" id="user-table" aria-label="POS users">
            <thead>
              <tr>
                <th style="width:34%">Username</th>
                <th style="width:18%">Role</th>
                <th style="width:18%">Status</th>
                <th style="width:30%">Actions</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
          <div class="hint">Users are stored locally for demo. Integrate with OC controller to persist.</div>
        </div>
      </section>

      <section class="panel" id="panel-sales" hidden>
  <div class="grid">

    <div class="field">
      <label>Auto Sync Sales</label>
      <div class="row">
        <div class="toggle {{ settings.setting_bpos_autosync?'on':'' }}" data-bind="autosync"><i></i></div>
        <span>Sync periodically</span>
      </div>
    </div>

    <div class="field">
      <label>Sync Interval</label>
      <select id="sync_interval" name="sync_interval">
        <option value="5m" {{ settings.setting_bpos_sync_interval=='5m'?'selected':'' }}>5 minutes</option>
        <option value="10m" {{ settings.setting_bpos_sync_interval=='10m'?'selected':'' }}>10 minutes</option>
        <option value="30m" {{ settings.setting_bpos_sync_interval=='30m'?'selected':'' }}>30 minutes</option>
      </select>
    </div>

    <div class="field">
      <label>Online Status</label>
      <div class="row">
        <div class="toggle {{ settings.setting_bpos_online_status?'on':'' }}" data-bind="online_status"><i></i></div>
        <span>Show cashier online/idle</span>
      </div>
    </div>

    <div class="field">
      <label>Stock Deduction</label>
      <div class="row">
        <div class="toggle {{ settings.setting_bpos_stock_deduct?'on':'' }}" data-bind="stock_deduct"><i></i></div>
        <span>Deduct stock on checkout</span>
      </div>
    </div>

    <div class="field">
      <label>Export Sales</label>
      <div class="row">
        <select id="export_fmt" name="export_fmt">
          <option value="csv" {{ settings.setting_bpos_export_fmt=='csv'?'selected':'' }}>CSV</option>
          <option value="xlsx" {{ settings.setting_bpos_export_fmt=='xlsx'?'selected':'' }}>XLSX</option>
        </select>
        <button class="btn" id="btnExportSales">Export</button>
      </div>
    </div>

    <div class="field">
      <label>Last Sync Log</label>
      <div class="status">
        <i></i>
        <span id="sync-log">{{ settings.setting_bpos_last_sync_log ?? 'No sync yet' }}</span>
      </div>
    </div>

  </div>
</section>

<section class="panel" id="panel-advanced" hidden>
  <div class="grid">

    <div class="field">
      <label for="api_url">API URL</label>
      <input type="text" id="api_url" name="api_url"
             value="{{ settings.setting_bpos_api_url ?? '' }}">
    </div>

    <div class="field">
      <label for="api_key">API Key</label>
      <input id="api_key" name="api_key" type="password"
             value="{{ settings.setting_bpos_api_key ?? '' }}">
    </div>

    <div class="field">
      <label>Cache</label>
      <div class="row">
        <button class="btn" id="btn-clear-cache">Clear Cache</button>
        <button class="btn" id="btn-reset-ls">Reset Local Storage</button>
      </div>
    </div>

    <div class="field">
      <label>Diagnostics</label>
      <div class="row">
        <button class="btn" id="btn-test-conn">Test Connection</button>
        <span id="diag-result" class="muted"></span>
      </div>
      <div class="hint">Ping API endpoint.</div>
    </div>

  </div>
</section>

<section class="panel" id="panel-help" hidden>
  <div class="grid">

    <!-- Quick Start -->
    <div class="field">
      <label class="section-title">Quick Start</label>
      <div class="note">
        1) Set <b>Store</b>, <b>Language</b>, and <b>Currency</b>.<br>
        2) Enable <b>Barcode Scanner</b> and <b>Printer</b> if needed.<br>
        3) Configure <b>Cashier & Permission</b>.<br>
        4) Open your POS at <span class="kbd">/pos</span> and start selling ðŸŽ‰
      </div>
    </div>

    <!-- Troubleshooting -->
    <div class="field">
      <label class="section-title">Troubleshooting</label>
      <div class="note">
        If printing fails on a thermal printer, switch <b>Print Type</b> or reduce logo density.<br>
        Use <b>Reset Local Storage</b> if UI behaves oddly after updates.
      </div>
    </div>

    <!-- Contact -->
    <div class="field">
      <label class="section-title">Contact</label>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button type="button" class="btn ghost" id="help-docs">ðŸ“– Documentation</button>
        <button type="button" class="btn ghost" id="help-ticket">ðŸŽ« Open Ticket</button>
      </div>
      <div class="hint">Need more help? Check the documentation or contact support.</div>
    </div>

  </div>
</section>



    <div class="savebar">
      <div class="left">Changes are not saved</div>
      <div class="right">
        <button class="btn" id="discard">Discard</button>
        <button class="btn primary" id="save">Save Settings</button>
      </div>
    </div>
  </div>
  <div class="toast" id="toast"></div>
   <div class="modal" id="user-modal" aria-hidden="true" role="dialog" aria-labelledby="user-modal-title">
    <div class="sheet-setting">
      <header>
        <strong id="user-modal-title">New User</strong>
        <button class="btn small" id="user-modal-close">âœ•</button>
      </header>
      <div class="body">
        <div class="grid">
          <div class="field">
            <label for="u-username">Username</label>
            <input id="u-username" type="text" placeholder="e.g., cashier01">
          </div>
          <div class="field">
            <label for="u-pin">PIN</label>
            <input id="u-pin" type="password" placeholder="4â€“6 digits">
          </div>
          <div class="field">
            <label for="u-role">Role</label>
            <select id="u-role">
        <option value="admin">
          Admin
        </option>
        <option value="staff">
          Staff
        </option>
            </select>
          </div>
          <div class="field">
            <label for="u-active">Active</label>
            <div class="row"><div id="u-active" class="toggle on"><i></i></div><span>Enable login</span></div>
          </div>
        </div>
      </div>
      <footer>
        <button class="btn" id="user-modal-cancel">Cancel</button>
        <button class="btn primary" id="user-modal-save">Save User</button>
      </footer>
    </div>
  </div>
</div>

 
  <link rel="stylesheet" href="catalog/view/theme/default/stylesheet/bpos/setting.css">
<script>
(function(){
  if (!window.notyf) {
  window.notyf = new Notyf({
    duration: 1800,
    position: { x: 'right', y: 'bottom' }
  });
}
  const REQUIRED_FIELDS = ['pos_name','pos_path'];
  const toast = document.getElementById('toast');
  const savebarLeft = document.querySelector('.savebar .left');
   const showToast = (msg, ok = true) => {
    if (!window.notyf) {
      window.notyf = new Notyf({
        duration: 2000,
        ripple: true,
        position: { x: 'right', y: 'bottom' },
        dismissible: true
      });
    }

    if (ok) {
      window.notyf.success(msg);
    } else {
      window.notyf.error(msg);
    }
  };
  const dirty = ()=> savebarLeft.textContent = 'Unsaved changes';
  const val = id => document.getElementById(id)?.value || '';
  // === Language pills toggle ===
  document.addEventListener('click', e => {
    const pill = e.target.closest('.pill');
    if (!pill || !pill.dataset.lang) return; // klik bukan tombol bahasa

    const wrapper = pill.closest('.lang-pills');
    if (!wrapper) return;

    wrapper.querySelectorAll('.pill').forEach(p => {
      p.classList.remove('active');
      p.setAttribute('aria-selected', 'false');
    });

    pill.classList.add('active');
    pill.setAttribute('aria-selected', 'true');

    const lang = pill.dataset.lang;

    document.querySelectorAll('.lang-group').forEach(g => {
      g.classList.remove('active');
    });

    const targetGroup = document.querySelector(`.lang-group[data-group="${lang}"]`);
    if (targetGroup) targetGroup.classList.add('active');
  });
  // === Tabs ===
  const tabButtons = document.querySelectorAll('.tabs [role="tab"]');
  const panels = {};
  document.querySelectorAll('section.panel[id^="panel-"]').forEach(p => panels[p.id.replace('panel-', '')] = p);
  tabButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabButtons.forEach(b=>b.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
      const key = btn.dataset.tab;
      Object.keys(panels).forEach(k => panels[k].hidden = (k !== key));
    });
  });

  // === Toggle handling ===
  document.querySelectorAll('.toggle').forEach(t=>{
    t.addEventListener('click', ()=>{ t.classList.toggle('on'); dirty(); });
  });

  // === Input changes mark dirty ===
  document.querySelectorAll('input,select,textarea').forEach(el=>{
    el.addEventListener('input', dirty);
    el.addEventListener('change', dirty);
  });

  // === Validation helpers ===
  function markInvalid(ids){
    let focused = false;
    ids.forEach(id=>{
      const wrap = document.querySelector('.field[data-field="'+id+'"]');
      if(wrap){
        wrap.classList.add('invalid');
        if(!focused){
          const input = wrap.querySelector('input,select,textarea');
          if(input){ input.focus(); focused = true; }
        }
      }
    });
  }

  // === Load settings defaults (from data-value or saved) ===
  try{
    const saved = JSON.parse(localStorage.getItem('bpos_settings_array')||'null');
    if(saved && Array.isArray(saved)){
      saved.forEach(([k,v])=>{
        const el = document.getElementById(k);
        if(el!=null && typeof v!=='undefined'){ el.value = v; }
        const tg = document.querySelector('.toggle[data-bind="'+k+'"]');
        if(tg){ tg.classList.toggle('on', !!v); }
      });
    }else{
      document.querySelectorAll('[data-value]').forEach(el=>{
        const dv = el.getAttribute('data-value');
        if(el.tagName==='TEXTAREA'){ if(el.value.trim()==='') el.value = dv || ''; }
        else{ if(el.value==='' && dv!=null) el.value = dv; }
      });
    }
  }catch(e){ console.warn(e); }

  // ======== USERS ========
  const U_KEY = 'bpos_users';
  const tableBody = document.querySelector('#user-table tbody');
  const countBadge = document.getElementById('user-count');
  const searchBox = document.getElementById('user-search');
  const searchClear = document.getElementById('user-search-clear');
  const modal = document.getElementById('user-modal');
  const modalTitle = document.getElementById('user-modal-title');
  const mUser = { id:null, mode:'create' };

  function uid(){ return 'U' + Math.random().toString(36).slice(2,8).toUpperCase(); }
  function nowISO(){ return new Date().toISOString(); }

  let users = [];

  async function fetchUsers(){
    try {
      const res = await fetch('index.php?route=bpos/setting/users');
      const text = await res.text();
      try {
        const json = JSON.parse(text);
        if(json.success && Array.isArray(json.data)){
         users = json.data.map(u => ({
            id: u.user_bpos_id,
            username: u.username,
            role: u.role, 
            active: u.status == 1,
            createdAt: u.date_added
          }));
          renderUsers();
        } else {
          console.warn('Unexpected JSON:', json);
          showToast('Failed to load users', false);
        }
      } catch(err) {
        console.error('JSON parse failed:', text);
        showToast('Invalid JSON response', false);
      }
    } catch(e) {
      console.error(e);
      showToast('Error fetching users', false);
    }
  }

  function renderUsers(){
    const q = (searchBox.value||'').trim().toLowerCase();
    const rows = users.filter(u=>{
      if(!q) return true;
      return (u.username||'').toLowerCase().includes(q);
    });
    countBadge.textContent = rows.length + (rows.length===1 ? ' user' : ' users');
    tableBody.innerHTML = rows.map(u=>`
      <tr data-id="${u.id}">
        <td><strong>${u.username}</strong>
          <div class="hint">Created ${new Date(u.createdAt).toLocaleString()}</div></td>
        <td><span class="badge-sm ${u.role==='admin'?'warn':'muted'}">
    ${u.role.charAt(0).toUpperCase() + u.role.slice(1)}
  </span></td>
        <td>${u.active ? '<span class="badge-sm ok">Active</span>' : '<span class="badge-sm off">Disabled</span>'}</td>
        <td>
          <div class="right">
            <button class="btn small" data-act="toggle">${u.active?'Disable':'Enable'}</button>
            <button class="btn small" data-act="reset">Reset PIN</button>
            <button class="btn small" data-act="edit">Edit</button>
            <button class="btn small danger" data-act="delete">Delete</button>
          </div>
        </td>
      </tr>`).join('');
  }

  function openModal(mode, user){
    mUser.mode = mode;
    mUser.id = user ? user.id : null;
    modalTitle.textContent = mode==='create' ? 'New User' : 'Edit User';
    document.getElementById('u-username').value = user ? user.username : '';
    document.getElementById('u-pin').value = '';
    document.getElementById('u-role').value = user ? user.user_group_id : '';
    document.getElementById('u-active').classList.toggle('on', user ? !!user.active : true);
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }
  document.addEventListener('click', e=>{
    if (e.target.closest('#u-active')) {
      document.getElementById('u-active').classList.toggle('on');
    }
  });

  document.getElementById('btn-add-user').addEventListener('click', ()=>openModal('create'));
  document.getElementById('user-modal-close').addEventListener('click', closeModal);
  document.getElementById('user-modal-cancel').addEventListener('click', closeModal);
  document.getElementById('u-active').addEventListener('click', e=>e.currentTarget.classList.toggle('on'));

  document.getElementById('user-modal-save').addEventListener('click', async ()=>{
  const username = document.getElementById('u-username').value.trim();
  const pin = document.getElementById('u-pin').value.trim();
  const role = document.getElementById('u-role').value;
  const active = document.getElementById('u-active').classList.contains('on');

  if(!username){ showToast('Username is required', false); return; }
  if(mUser.mode==='create' && (!pin || pin.length < 4 || pin.length > 6)){
    showToast('PIN must be 4â€“6 digits', false); return;
  }

  const payload = {
    username,
    pin,
    role,
    status: active ? 1 : 0
  };
  if(mUser.mode === 'edit') payload.user_id = mUser.id;

  const route = mUser.mode==='create' ? 'bpos/setting/addUser' : 'bpos/setting/editUser';
  
  try {
    const res = await fetch(`index.php?route=${route}`, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams(payload)
    });
    const json = await res.json();

    if(json.success){
      if (window.notyf) notyf.success(json.message || 'User saved');
      else showToast(json.message || 'User saved');
      await fetchUsers(); // âœ… refresh list
      closeModal();
    } else {
      showToast(json.message || 'Failed to save user', false);
    }
  } catch(e){
    console.error(e);
    showToast('Error saving user', false);
  }
});

  // Table actions
  tableBody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const tr = btn.closest('tr'); const id = tr.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    const idx = users.findIndex(x=>x.id == id); if(idx<0) return;

    if(act==='toggle'){
      const newStatus = users[idx].active ? 0 : 1;
      const res = await fetch(`index.php?route=bpos/setting/setUserStatus&format=json`, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: `user_id=${id}&status=${newStatus}`
      });
      const json = await res.json();
      if(json.success){ showToast('Status updated'); fetchUsers(); }
      else showToast('Failed', false);
    } else if(act==='reset'){
      showToast('PIN reset link sent');
    } else if(act==='edit'){
      openModal('edit', users[idx]);
    } else if(act==='delete'){
      if(confirm('Delete this user?')){
        const res = await fetch(`index.php?route=bpos/setting/deleteUser&format=json`, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: `user_id=${id}`
        });
        const json = await res.json();
        if(json.success){ showToast('User deleted'); fetchUsers(); }
        else showToast('Failed to delete', false);
      }
    }
  });

  // Search
  searchBox.addEventListener('input', renderUsers);
  searchClear.addEventListener('click', ()=>{ searchBox.value=''; renderUsers(); });

  // === Save all settings ===
  document.getElementById('save').addEventListener('click', async ()=>{

  const payload = {};

  document.querySelectorAll('input[name], select[name], textarea[name]').forEach(el => {
    payload[ el.getAttribute('name') ] = el.value;
  });

  document.querySelectorAll('.toggle[data-bind]').forEach(tg=>{
    const key = tg.getAttribute('data-bind');
    payload[key] = tg.classList.contains('on') ? 1 : 0;
  });

  for (let role of ['admin', 'staff']) {
    for (let key in perms[role]) {
      payload[`perm_${role}_${key}`] = perms[role][key];
    }
  }

  console.log(payload); // Debug

  try {
    const res = await fetch('index.php?route=bpos/setting/save&format=json', {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams(payload).toString()
    });
    const json = await res.json();
    if(json.success){
      if(window.notyf){ notyf.success('Settings saved'); }
    }else{
      if(window.notyf){ notyf.error(json.message || 'Failed to save'); }
    }
  } catch(e){
    console.error(e);
    if(window.notyf){ notyf.error('Save error'); }
  }
});



  // discard
  document.getElementById('discard').addEventListener('click', ()=>{ location.reload(); });

  // init
  fetchUsers();
  const permBox = document.getElementById('perm-box');
const roleSelect = document.getElementById('role_default');

// default structure (admin & staff)
let perms = {
  admin: {
    home: {{ settings.setting_bpos_perm_admin_home ? 1 : 0 }},
    order: {{ settings.setting_bpos_perm_admin_order ? 1 : 0 }},
    report: {{ settings.setting_bpos_perm_admin_report ? 1 : 0 }},
    customer: {{ settings.setting_bpos_perm_admin_customer ? 1 : 0 }},
    setting: {{ settings.setting_bpos_perm_admin_setting ? 1 : 0 }}
  },
  staff: {
    home: {{ settings.setting_bpos_perm_staff_home ? 1 : 0 }},
    order: {{ settings.setting_bpos_perm_staff_order ? 1 : 0 }},
    report: {{ settings.setting_bpos_perm_staff_report ? 1 : 0 }},
    customer: {{ settings.setting_bpos_perm_staff_customer ? 1 : 0 }},
    setting: {{ settings.setting_bpos_perm_staff_setting ? 1 : 0 }}
  }
};

// label map
const PERM_LABELS = {
  home: 'Create Order',
  order: 'Orders Page',
  report: 'Reports Page',
  customer: 'Customers Page',
  setting: 'Settings'
};

// render permissions for current role
function renderPerms(role) {
  const p = perms[role];
  let html = '';
  for (let key in p) {
    html += `
      <label>
        <input type="checkbox" data-role="${role}" data-key="${key}" ${p[key] ? 'checked' : ''}>
        ${PERM_LABELS[key]}
      </label><br>`;
  }
  permBox.innerHTML = html;
}

// update permission value when checkbox clicked
permBox.addEventListener('change', e=>{
  const cb = e.target;
  if (cb && cb.dataset.key && cb.dataset.role) {
    const r = cb.dataset.role;
    const k = cb.dataset.key;
    perms[r][k] = cb.checked ? 1 : 0;
  }
});

// change role
roleSelect.addEventListener('change', ()=>{
  const role = roleSelect.value;
  renderPerms(role);
});

// init render
renderPerms(roleSelect.value);
})();
</script>

